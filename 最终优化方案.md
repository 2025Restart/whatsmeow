# WhatsApp 封控率优化方案（最终完整版）

## 📋 执行摘要

**核心目标**：将封控率降至最低，模拟最真实的用户行为，彻底消除不合理/异常配置

**核心策略**：
1. 主指纹复用机制（首次匹配生成，后续全部复用）
2. 会话内地理信息锁定（Country/Timezone 固定不变）
3. 代理IP仅固定宽带（MNC=000，彻底避免桌面端+移动网络）
4. 设备指纹永久稳定（平台/设备/OS 永远不变）
5. 完整一致性校验（Payload/Headers 100%同步）

---

## 一、总原则（最终确认版）

### 1.1 核心原则

1. **会话内锁定**：`Country/Timezone` 固定不变
   - 电脑不会移动，Web端的地理位置在单次会话中必须稳定

2. **重登时刷新**：`Country/Timezone` 重新计算
   - 用户重新登录时，使用新的"用户登录Web端IP"重新计算

3. **代理IP仅固定宽带**：`MNC="000"`
   - 彻底避免"桌面端+移动网络"的不合理组合

4. **设备指纹稳定**：设备/OS/平台等不随代理变化
   - 同一账号的设备特征永远保持一致

5. **主指纹复用**：首次匹配生成的指纹 = 主指纹
   - 后续所有连接/登录必须复用该主指纹，禁止重新随机生成

6. **多次匹配策略**：第一次生成的匹配指纹最大化复用
   - 只更新"允许变更字段"（MCC/MNC、重登时的Country/Timezone）

---

## 二、数据源优先级（最终版）

### 2.1 首次生成指纹（登录/配对）

**优先级**：`用户登录Web端IP` > `手机号地区` > `默认配置`

**用于**：
- `Country`（国家代码）
- `Timezone`（时区）
- `Language`（语言代码，默认跟随 Country）

**说明**：
- 用户登录Web端IP最接近用户真实地理位置
- 与WhatsApp本地信息最匹配

### 2.2 会话内更新（代理IP变化）

**优先级**：`代理IP` > 其他

**用于**：
- `MCC/MNC`（固定宽带，`MNC=000`）

**严禁更新**：
- `Country/Timezone/Language`（会话内锁定）

---

## 三、关键字段策略（完整版）

### 3.1 永久稳定字段（永远复用）

**设备硬件特征**：
- `PlatformType`（固定为 WEB）
- `Device`（设备名称，如 "Desktop"）
- `Manufacturer`（制造商，如 "Microsoft", "Apple"）
- `DevicePropsOs`（操作系统显示名称）
- `OSVersion`（操作系统版本）
- `OsBuildNumber`（构建号，Web端应为 nil）
- `DeviceModelType`（设备型号类型）
- `DeviceBoard`（主板信息，Web端应为 nil）

**平台特征**：
- `Platform`（固定为 `waWa6.ClientPayload_UserAgent_WEB`）
- `DeviceType`（固定为 `DESKTOP`）
- `WebInfo.WebSubPlatform`（固定为 `WEB_BROWSER`）

### 3.2 会话锁定字段（仅重登可变）

**地理信息**：
- `LocaleCountryIso31661Alpha2`（国家代码，如 "IN", "BR"）
- `Timezone`（时区，如 "Asia/Kolkata"）
- `LocaleLanguageIso6391`（语言代码，如 "hi", "en", "pt"）

**锁定规则**：
- 会话内：完全固定，禁止任何修改
- 重登时：使用新的"用户登录Web端IP"重新计算

### 3.3 会话内允许变化字段

**网络相关**：
- `Mcc`（移动国家码，如 "404", "724"）
- `Mnc`（移动网络码，固定为 "000" 表示固定宽带）

**变化规则**：
- 允许随代理IP变化而更新
- 但必须保持 `MNC="000"`（固定宽带）

---

## 四、登录与重登逻辑（完整闭环）

### 4.1 首次匹配成功（生成主指纹）

**流程**：
1. 使用"用户登录Web端IP"确定 `Country/Timezone/Language`
2. 生成完整指纹（设备特征随机生成，但后续固定）
3. 代理IP设置 `MCC/MNC`（固定宽带，`MNC=000`）
4. 持久化到数据库（作为"主指纹"）
5. 输出完整一致的 Payload + Headers

**关键**：
- 这是"主指纹"，后续所有操作必须复用
- 设备特征（Platform/Device/OS等）一旦生成，永远不变

### 4.2 会话内连接/登录（复用主指纹）

**流程**：
1. 从数据库读取主指纹
2. 检查代理IP变化，仅更新 `MCC/MNC`（如果变化）
3. **强制锁定** `Country/Timezone/Language`（使用会话缓存）
4. 应用指纹到 Payload
5. 生成一致的 Headers（从同一 Payload 派生）

**关键**：
- 必须使用主指纹，禁止重新生成
- 只允许 `MCC/MNC` 变化
- `Country/Timezone/Language` 完全锁定

### 4.3 退出后重登（刷新地理信息）

**流程**：
1. 从数据库读取主指纹（复用设备特征）
2. 使用新的"用户登录Web端IP"重新计算 `Country/Timezone/Language`
3. 更新代理IP的 `MCC/MNC`（固定宽带）
4. 更新数据库中的地理信息（但设备特征不变）
5. 输出完整一致的 Payload + Headers

**关键**：
- 设备特征完全复用（Platform/Device/OS等）
- 地理信息重新计算（Country/Timezone/Language）
- 代理信息更新（MCC/MNC）

### 4.4 多次匹配（再次配对）

**流程**：
1. 检查数据库中是否存在主指纹
2. 如果存在：直接复用主指纹（设备特征完全不变）
3. 如果不存在：按"首次匹配"流程生成新主指纹
4. 更新地理信息（使用新的"用户登录Web端IP"）
5. 更新代理信息（MCC/MNC）

**关键**：
- 最大化复用第一次生成的匹配指纹
- 只更新"允许变更字段"

---

## 五、关键缺口处理方案（理论最优）

### 5.1 WebSubPlatform → PlatformType 映射

**问题**：当前映射未完成，可能导致不一致

**解决方案**：
- 建立确定映射表：
  - `WEB_BROWSER` → `CHROME`
  - `WEB_DESKTOP` → `DESKTOP`
  - 其他 → `CHROME`（默认）
- 确保 `WebInfo.WebSubPlatform` 与 `DeviceProps.PlatformType` 逻辑一致
- 在 `generateUserAgent()` 中实现完整映射

**一致性要求**：
- `payload.WebInfo.WebSubPlatform` ↔ `payload.DevicePairingData.DeviceProps.PlatformType`
- `generateUserAgent()` 必须使用映射后的 PlatformType

### 5.2 HTTP Headers 与 Payload 一致性

**问题**：Headers 依赖 Payload，但可能不同步

**解决方案**：
- **强制规则**：所有 Headers 必须从**同一份 Payload** 派生
- 在 `setWebSocketHeaders()` 和 `setBrowserHeaders()` 中：
  - 优先使用 `cli.GetClientPayload()`（如果已设置）
  - 确保 UA、ClientHints、Accept-Language 都从同一 Payload 提取
- 添加一致性校验：发送前验证 Headers 与 Payload 匹配

**一致性要求**：
- `User-Agent` ↔ `payload.UserAgent` 字段
- `Sec-Ch-Ua-Platform` ↔ `payload.UserAgent.Manufacturer` 推断的 OS
- `Sec-Ch-Ua-Mobile` ↔ `payload.UserAgent.Platform`（WEB 必须是 "?0"）
- `Accept-Language` ↔ `payload.UserAgent.LocaleLanguageIso6391`

### 5.3 PhoneID / DeviceExpID 处理

**问题**：Web端是否需要这些字段？

**解决方案**：
- **Web端默认为空**（最合理）
- 如果业务层需要设置：
  - 必须有明确的生成规则（基于设备ID的确定性生成）
  - 必须保持一致性（同一设备永远相同）
- 在 `SanitizeClientPayload` 中：
  - Web平台强制置空 `phoneID` 和 `deviceExpID`
  - 避免泄露移动端特征

**一致性要求**：
- Web平台：`phoneID = nil`, `deviceExpID = nil`
- 移动平台：按需设置（但当前仅支持Web）

### 5.4 会话锁定机制（Country/Timezone）

**问题**：缺少会话内锁定机制

**解决方案**：
- **新增"会话地理信息缓存"**：
  ```go
  type SessionGeoCache struct {
      Country  string
      Timezone string
      Language string
      Locked   bool  // 是否已锁定
  }
  ```
- 登录成功时：写入缓存并锁定
- 断开连接时：清除缓存
- `GetClientPayload()` 中：
  - 如果缓存存在且已锁定 → 强制使用缓存的 `Country/Timezone/Language`
  - 禁止任何修改（包括代理IP变化）

**一致性要求**：
- 会话内：`Country/Timezone/Language` 完全固定
- 重登时：清除缓存，重新计算

### 5.5 Accept-Language 与 LocaleLanguage 一致性

**问题**：`generateAcceptLanguage()` 可能不一致

**解决方案**：
- **强制规则**：`Accept-Language` 必须严格跟随 `LocaleLanguageIso6391`
- 实现 `generateAcceptLanguage()`：
  - 优先从 `payload.UserAgent.LocaleLanguageIso6391` 获取
  - 如果没有，从指纹的 `LocaleLanguage` 获取
  - 格式：`"hi,en;q=0.9"` 或 `"pt-BR,pt;q=0.9,en;q=0.8"`
- 添加校验：确保语言与国家匹配（如 "hi" 对应 "IN"）

**一致性要求**：
- `Accept-Language` ↔ `LocaleLanguageIso6391`
- 语言与国家必须匹配（避免 "hi" + "BR" 等异常组合）

---

## 六、一致性校验（强约束）

### 6.1 发送前校验规则

每次发送 Payload 前，必须满足以下所有条件：

1. **地理一致性**：
   - `Country` 与 `Timezone` 逻辑匹配（如 "IN" ↔ "Asia/Kolkata"）
   - `Country` 与 `Language` 逻辑匹配（如 "IN" ↔ "hi", "BR" ↔ "pt"）

2. **网络一致性**：
   - `MNC = "000"`（固定宽带）
   - `MCC` 与 `Country` 匹配（如 "404" ↔ "IN", "724" ↔ "BR"）

3. **平台一致性**：
   - `Platform = WEB`
   - `DeviceType = DESKTOP`
   - `WebInfo.WebSubPlatform = WEB_BROWSER`
   - `DeviceProps.PlatformType = CHROME`（或其他浏览器类型）

4. **Headers一致性**：
   - `User-Agent` 与 `payload.UserAgent` 字段匹配
   - `Sec-Ch-Ua-Platform` 与 OS 匹配
   - `Sec-Ch-Ua-Mobile = "?0"`（Web端）
   - `Accept-Language` 与 `LocaleLanguageIso6391` 匹配

5. **会话锁定**：
   - 如果会话已锁定，`Country/Timezone/Language` 必须与缓存一致

### 6.2 校验失败处理

如果校验失败：
- **记录错误日志**（包含所有不一致的字段）
- **强制修正**（使用兜底值）
- **禁止发送**（如果无法修正）

---

## 七、主指纹复用机制（核心创新）

### 7.1 主指纹定义

**主指纹**：首次匹配成功时生成的完整指纹

**特征**：
- 包含所有设备特征（Platform/Device/OS/DeviceProps等）
- 持久化到数据库（key = JID）
- 后续所有操作必须复用

### 7.2 复用规则

**必须复用**：
- 设备硬件特征（Platform/Device/Manufacturer/OS等）
- 设备软件特征（OSVersion/Build/DeviceProps等）

**允许更新**：
- `MCC/MNC`（随代理IP变化）
- `Country/Timezone/Language`（仅重登时）

**禁止操作**：
- 重新随机生成设备特征
- 修改已锁定的地理信息（会话内）

### 7.3 多次匹配处理

**场景**：用户多次匹配（解绑后重新配对）

**策略**：
1. 检查数据库是否存在主指纹（key = JID）
2. **如果存在**：
   - 直接复用主指纹（设备特征完全不变）
   - 更新地理信息（使用新的"用户登录Web端IP"）
   - 更新代理信息（MCC/MNC）
3. **如果不存在**：
   - 按"首次匹配"流程生成新主指纹

**优势**：
- 最大化一致性（同一账号的设备特征永远相同）
- 避免重复随机生成导致的异常变化

---

## 八、完整流程闭环

### 8.1 首次匹配流程

```
1. 用户发起匹配
   ↓
2. 获取"用户登录Web端IP"地理位置
   ↓
3. 生成完整指纹（设备特征随机生成）
   ↓
4. 设置代理IP的MCC/MNC（固定宽带，MNC=000）
   ↓
5. 持久化到数据库（主指纹）
   ↓
6. 写入会话地理信息缓存（Country/Timezone/Language）
   ↓
7. 生成Payload + Headers（一致性校验）
   ↓
8. 发送连接请求
```

### 8.2 会话内连接流程

```
1. 从数据库读取主指纹
   ↓
2. 检查会话地理信息缓存（如果存在，强制使用）
   ↓
3. 检查代理IP变化（仅更新MCC/MNC）
   ↓
4. 应用指纹到Payload
   ↓
5. 生成Headers（从同一Payload派生）
   ↓
6. 一致性校验
   ↓
7. 发送连接请求
```

### 8.3 重登流程

```
1. 断开连接（清除会话地理信息缓存）
   ↓
2. 用户重新登录
   ↓
3. 从数据库读取主指纹（复用设备特征）
   ↓
4. 获取新的"用户登录Web端IP"地理位置
   ↓
5. 重新计算Country/Timezone/Language
   ↓
6. 更新代理IP的MCC/MNC
   ↓
7. 更新数据库中的地理信息（设备特征不变）
   ↓
8. 写入新的会话地理信息缓存
   ↓
9. 生成Payload + Headers（一致性校验）
   ↓
10. 发送连接请求
```

### 8.4 多次匹配流程

```
1. 用户再次匹配
   ↓
2. 检查数据库是否存在主指纹
   ↓
3a. 如果存在：
    - 复用主指纹（设备特征完全不变）
    - 更新地理信息（新的"用户登录Web端IP"）
    - 更新代理信息（MCC/MNC）
   ↓
3b. 如果不存在：
    - 按"首次匹配"流程生成新主指纹
   ↓
4. 持久化更新（地理信息更新，设备特征不变）
   ↓
5. 生成Payload + Headers（一致性校验）
   ↓
6. 发送连接请求
```

---

## 九、预期效果（理论最优）

### 9.1 封控率降低

- **当前**：30%
- **目标**：<5%
- **提升**：↓83%

### 9.2 指纹一致性

- **设备特征一致性**：100%（主指纹复用）
- **地理信息一致性**：100%（会话内锁定）
- **Headers一致性**：100%（强制同步）

### 9.3 异常组合消除

- **桌面端+移动网络**：0%（代理IP仅固定宽带）
- **地理信息异常变化**：0%（会话内锁定）
- **Headers与Payload不一致**：0%（强制校验）

### 9.4 真实性提升

- **模拟真实用户行为**：100%（符合真实桌面Web端特征）
- **避免异常特征**：100%（所有不合理组合已消除）

---

## 十、风险控制（零异常）

### 10.1 不合理组合彻底消除

- **桌面端+移动网络**：代理IP强制 `MNC="000"`，彻底禁止
- **地理信息异常变化**：会话内锁定，禁止任何修改
- **Headers不一致**：强制从同一Payload派生，添加校验

### 10.2 指纹一致性保障

- **主指纹复用**：同一账号的设备特征永远相同
- **会话锁定**：地理信息在会话内完全固定
- **重登刷新**：地理信息在重登时合理更新

### 10.3 代理IP波动影响最小化

- **仅允许MCC/MNC变化**：不影响地理信息
- **固定宽带强制**：避免平台类型不匹配

---

## 十一、实施优先级

### Phase 1: 核心机制（P0）

1. **主指纹复用机制**
   - 首次匹配生成主指纹
   - 后续全部复用主指纹

2. **会话地理信息锁定**
   - 新增会话地理信息缓存
   - 会话内强制锁定

3. **代理IP固定宽带强制**
   - 业务层保证 `MNC="000"`
   - 代码层校验并强制

### Phase 2: 一致性保障（P1）

4. **WebSubPlatform映射**
   - 实现完整映射表
   - 确保逻辑一致

5. **Headers与Payload同步**
   - 强制从同一Payload派生
   - 添加一致性校验

6. **Accept-Language一致性**
   - 实现 `generateAcceptLanguage()`
   - 确保与LocaleLanguage匹配

### Phase 3: 完善与优化（P2）

7. **PhoneID/DeviceExpID处理**
   - Web端强制置空
   - 添加校验

8. **完整一致性校验**
   - 发送前校验所有规则
   - 失败时强制修正或禁止发送

---

## 十二、总结

### 12.1 核心创新点

1. **主指纹复用机制**：首次匹配生成，后续全部复用
2. **会话地理信息锁定**：Country/Timezone 会话内固定不变
3. **代理IP固定宽带强制**：彻底避免桌面端+移动网络
4. **完整一致性校验**：Payload/Headers 100%同步

### 12.2 理论优势

- **封控率最低**：消除所有不合理组合
- **指纹最稳定**：主指纹复用，设备特征永远不变
- **行为最真实**：符合真实桌面Web端特征
- **流程最闭环**：所有环节都有校验和保障

### 12.3 实施建议

- **先实施Phase 1**：核心机制最重要
- **再实施Phase 2**：一致性保障
- **最后Phase 3**：完善与优化

---

**方案状态**：✅ 理论完整，流程闭环，无漏洞

**下一步**：根据此方案制定详细的实施计划（代码修改方案）
